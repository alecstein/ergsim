<!doctype html>
<html>

<head>
  <meta charset="UTF-8\" />
  <script src="webui.js"></script>
  <script src="https://d3js.org/d3.v6.js"></script>
  <title>ideal gas and piston simulation</title>
</head>

<body>
  Gas
  <div id="density"></div>
  Momentum
  <div id="momentum"></div>
  <script>
    function rawBytesToCounts(byteArray) {
      const unpaddedBytes = byteArray.slice(6, -1);
      const uint8Array = new Uint8Array(unpaddedBytes);
      const buffer = uint8Array.buffer;
      const dataView = new DataView(buffer);
      const numInts = buffer.byteLength / 4; // Each U32 integer is 4 bytes
      let data = [];
      for (let i = 0; i < numInts; i++) {
        data[i] = dataView.getUint32(i * 4, true); // Read 32-bit integers
      }
      return data;
    }

    var nParticles = undefined;
    var xMax = 1.5;
    var xBins = 100;
    var vMax = .2;
    var mu = undefined;
    var vBins = 1000;
    vy = d3.scaleLinear().domain([0, .1]).range([height, 0]);


    var margin = { top: 50, right: 30, bottom: 30, left: 40 },
      width = 800 - margin.left - margin.right,
      height = 350 - margin.top - margin.bottom;

    function setConstants(n, mu_) {
      nParticles = n;

      vMax = Math.sqrt(mu_) * .1;
      mu = mu_;

      v = d3.scaleLinear().domain([-mu, mu]).range([0, width]);
      x = d3.scaleLinear().domain([0, xMax]).range([0, width]);
      console.log(height);
      vy = d3.scaleLinear().domain([0, 1000*1/Math.sqrt(Math.PI * mu)]).range([height, 0]);

      d3.select("#density > svg:nth-child(1) > g:nth-child(1) > text:nth-child(2)")
        .text("gas density (particle density) along x-axis, " + nParticles + " particles");

      drawMomentumPrediction(mu, vMax);
    };

    function drawMomentumPrediction(mu, vMax) {
      var numPoints = 200;
      var scaleFactor = Math.sqrt(Math.PI * mu);

      var lineData = Array.from({ length: numPoints }, (_, i) => {
        var v = -vMax + (i / numPoints) * (2 * vMax); // scale i to [-vMax, vMax]
        var y = Math.exp(-Math.pow(v, 2) / mu) / scaleFactor; // Normalized Gaussian function
        return { v: v, y: y };
      });


      var line = d3.line()
        .x(function (d) { return v(d.v); })
        .y(function (d) { return vy(d.y); });

      d3.select("#momentum > svg > g")
        .append("path")
        .datum(lineData)
        .attr("fill", "none")
        .attr("stroke", "blue")
        .attr("stroke-width", 1)
        .attr("d", line);
    };



    function initDensityHist() {
      x = d3.scaleLinear().domain([0, xMax]).range([0, width]);

      var svg = d3
        .select("#density")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      svg
        .append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x))
        .call((g) =>
          g
            .append("text")
            .attr("x", width)
            .attr("y", margin.bottom - 4)
            .attr("fill", "currentColor")
            .attr("text-anchor", "end")
            .text("x")
        );
    }

    initDensityHist();

    function updateDensityHist(bytes) {

      var svg = d3.select("#density svg g");

      var data = rawBytesToCounts(bytes);
      var binWidth = xMax / xBins;
      var x = d3.scaleLinear().domain([0, 1]).range([0, width]);
      var colorScale = d3.scaleLinear().domain([0, 500]).range(["white", "orange"]);

      // Bind the data to the rects
      var rects = svg.selectAll("rect")
        .data(data);

      // Enter selection: Add new rects for new data
      rects.enter().append("rect")
        .attr("x", 1)
        .attr("width", x(binWidth) - x(0)) // Width of each bin
        .attr("height", height) // Constant height for all bins
        .merge(rects) // Merge enter and update selections
        .attr("transform", function (d, i) {
          return "translate(" + x(i * binWidth) + ",0)";
        })
        .style("fill", function (d) {
          return colorScale(d);
        });

      // Exit selection: Remove rects that are no longer needed
      rects.exit().remove();
    }

    function initMomentumHistogram() {

      v = d3.scaleLinear().domain([-vMax, vMax]).range([0, width]);

      var svg = d3
        .select("#momentum")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      svg
        .append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(v))
        .call((g) =>
          g
            .append("text")
            // .attr("x", width)
            .attr("y", margin.bottom - 4)
            .attr("fill", "currentColor")
            .attr("text-anchor", "end")
            .text("p")
        );
    }

    initMomentumHistogram()

    function updateMomentumHist(bytes) {
      var svg = d3.select("#momentum svg g");

      var data = rawBytesToCounts(bytes);
      var totalArea = nParticles * 2 * vMax / 200;
      var normalizedData = data.map((d) => d / totalArea);
      var binWidth = 2 * vMax / vBins;

      // Update the axis if necessary
      svg.select(".axis")
        .call(d3.axisLeft(vy));

      // Bind the data to the rects
      var rects = svg.selectAll("rect")
        .data(normalizedData);

      // Enter selection: Create new rects for new data
      rects.enter().append("rect")
        .attr("width", 3)
        .style("fill", "black")
        // Set initial attributes for new rects here (if necessary)
        .merge(rects) // Merge enter and update selections
        .attr("v", 1)
        .attr("transform", function (d, i) {
          return "translate(" + v(i * binWidth - vMax) + ",0)";
        })
        .attr("y", function (d) { return vy(d); })
        .attr("height", function (d) { return height - vy(d); });

      // Exit selection: Remove rects that are no longer needed
      rects.exit().remove();
    }



  </script>
</body>

</html>