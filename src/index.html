<!doctype html>
<html>

<head>
  <meta charset="UTF-8\" />
  <script src="webui.js"></script>
  <script src="https://d3js.org/d3.v6.js"></script>
  <title>ideal gas and piston simulation</title>
</head>

<body>
  Gas
  <div id="density"></div>
  Momentum
  <div id="momentum"></div>
  <script>
    function rawBytesToCounts(byteArray) {
      const unpaddedBytes = byteArray.slice(6, -1);
      const uint8Array = new Uint8Array(unpaddedBytes);
      const buffer = uint8Array.buffer;
      const dataView = new DataView(buffer);
      const numInts = buffer.byteLength / 4; // Each U32 integer is 4 bytes
      let data = [];
      for (let i = 0; i < numInts; i++) {
        data[i] = dataView.getUint32(i * 4, true); // Read 32-bit integers
      }
      return data;
    }

    var nParticles = undefined;
    var particleMass = undefined;
    var pistonMass = undefined;

    var pistonX0 = undefined;
    var particleV0 = undefined;

    var totalE = undefined;
    var beta = undefined;
    var sigma = undefined;

    var xBins = undefined;
    var vBins = undefined;

    var beta = undefined;
    var sigma = undefined;

    var vMax = undefined;
    var xMax = undefined;

    var x = undefined;
    var v = undefined;
    var vy = undefined;

    var margin = { top: 50, right: 30, bottom: 30, left: 40 },
      width = 800 - margin.left - margin.right,
      height = 350 - margin.top - margin.bottom;

    function setConstants(n, m_particle, m_piston, piston_x, x_bins, v_bins, energy) {
      nParticles = n;
      xBins = x_bins;
      vBins = v_bins;

      particleMass = m_particle;
      pistonMass = m_piston;
      pistonX0 = piston_x;

      totalE = energy;
      beta = (3 * nParticles + 1) / (2 * energy);

      xMax = totalE / (pistonMass * 9.81);

      sigma = Math.sqrt(2 * totalE / (particleMass * (3 * nParticles + 1)));
      vMax = 5 * sigma;

      vMax = 5;

      v = d3.scaleLinear().domain([-vMax, vMax]).range([0, width]);
      x = d3.scaleLinear().domain([0, xMax]).range([0, width]);
      vy = d3.scaleLinear().domain([0, .6]).range([height, 0]);

      d3.select("#density > svg:nth-child(1) > g:nth-child(1) > text:nth-child(2)")
        .text("gas density (particle density) along x-axis, " + nParticles + " particles");

      drawMomentumPrediction();
    };

    function distributionFunc(v) {
      var nPrefactor = (3*nParticles + 1)/2;
      var normPrefactor = 1 / Math.sqrt(2 * Math.PI * totalE * particleMass);
      console.log(nPrefactor*normPrefactor);
      return nPrefactor * normPrefactor * (1 - particleMass * (v) ** 2 / (2 * totalE)) ** (3 * nParticles / 2)
    }

    function drawMomentumPrediction() {

      var numPoints = 200;
      var lineData = Array.from({ length: numPoints }, (_, i) => {
        var v = - vMax + (i / numPoints) * (2 * vMax); // scale i to [-vMax, vMax]
        return { v: v, y: distributionFunc(v) };
      });

      var line = d3.line()
        .x(function (d) { return v(d.v); })
        .y(function (d) { return vy(d.y); });

      d3.select("#momentum > svg > g")
        .append("path")
        .datum(lineData)
        .attr("fill", "none")
        .attr("stroke", "blue")
        .attr("stroke-width", 1)
        .attr("d", line);
    };



    function initDensityHist() {
      x = d3.scaleLinear().domain([0, xMax]).range([0, width]);


      var svg = d3
        .select("#density")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      svg
        .append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x))
        .call((g) =>
          g
            .append("text")
            .attr("x", width)
            .attr("y", margin.bottom - 4)
            .attr("fill", "currentColor")
            .attr("text-anchor", "end")
            .text("x (m)")
        );
    }

    initDensityHist();

    function updateDensityHist(bytes) {
      var svg = d3.select("#density svg g");
      svg.selectAll("rect").remove();
      data = rawBytesToCounts(bytes);
      var binWidth = xMax / xBins;
      var colorScale = d3.scaleLinear().domain([0, nParticles / 50]).range(["white", "orange"]);
      svg.selectAll("rect")
        .data(data)
        .enter()
        .append("rect")
        .attr("x", 1)
        .attr("transform", function (d, i) {
          return "translate(" + x(i * binWidth) + ",0)";
        })
        .attr("width", x(binWidth) - x(0)) // Width of each bin
        .attr("height", height) // Constant height for all bins
        .style("fill", function (d) {
          return colorScale(d);
        });

    }

    function initMomentumHistogram() {

      v = d3.scaleLinear().domain([-vMax, vMax]).range([0, width]);

      var svg = d3
        .select("#momentum")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      svg
        .append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(v))
        .call((g) =>
          g
            .append("text")
            .attr("x", width)
            .attr("width", 2) // Width of each bin
            .attr("y", margin.bottom - 4)
            .attr("fill", "currentColor")
            .attr("text-anchor", "end")
            .text("v (m/s)")
        );
    }

    initMomentumHistogram()

    function updateMomentumHist(bytes) {


      var svg = d3.select("#momentum svg g");
      svg.selectAll("rect").remove();

      data = rawBytesToCounts(bytes);
      var totalArea = nParticles * 2 * vMax / 200;
      var normalizedData = data.map((d) => d / totalArea);
      var binWidth = 2 * vMax / vBins;

      svg.append("g")
        .call(d3.axisLeft(vy));

      svg.selectAll("rect")
        .data(normalizedData)
        .enter()
        .append("rect")
        .attr("v", 1)
        .attr("transform", function (d, i) {
          return "translate(" + v(i * binWidth - vMax) + ",0)";
        })
        .attr("width", 2)
        .attr("y", function (d) { return vy(d); })
        .attr("height", function (d) { return height - vy(d); })
        .style("fill", "black");
    }


  </script>
</body>

</html>